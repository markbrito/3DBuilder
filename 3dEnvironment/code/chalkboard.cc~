#include <GL/glut.h>
#include <string.h>
#include <math.h>
#include <time.h>
#include "chalkboard.h"
#include "AscFile.h"
#include "list.h"

#define MAX_SPEED 10
#define PI 3.14

int objFan;
int objHooverCraft;
int objScene;
float speed=0;
float directionangle=0;
float fanangle=0;
float xpos=0;
float ypos=0;


List *ChalkBoard::objects;
///CollisionDetector *ChalkBoard::colldetector;

ChalkBoard::ChalkBoard(int argc, char **argv,int windowx,int windowy,
		       char *title,int x,int y,int width,int height,int z,int zdepth,List *objs)
{
  WINDOW_TITLE=strdup(title);
  X_START=x;
  Y_START=y;
  WIDTH=width;
  HEIGHT=height;
  ChalkBoard::objects=objs;
    //  ChalkBoard::colldetector=new CollisionDetector(ChalkBoard::objects);

  glutInit(&argc,argv);
  glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGB | GLUT_DEPTH );
  glutInitWindowSize(windowx,windowy);
  //  glutInitWindowPosition(100,100);
  glutCreateWindow(this->WINDOW_TITLE);
  glClearColor(0.0,0.0,0.0,0.0);
  glShadeModel(GL_SMOOTH);


    GLfloat light0Pos[4] = { 10.70F, 10.70F, 11.25F, 1.0F };
      GLfloat matAmb[4] = { 0.5F, 0.5F, 0.5F, .50F };
      GLfloat matDiff[4] = { 0.5F, 0.5F, 0.50F, .5F };
      GLfloat matSpec[4] = { 0.50F, 0.50F, 0.50F, .50F };
      GLfloat matShine = 20.00F;
	  glEnable(GL_NORMALIZE);
 
    glEnable( GL_LIGHTING );
      glEnable( GL_LIGHT0 );
	  glEnable(GL_COLOR_MATERIAL);
	 
	    glEnable(GL_DEPTH_TEST);
		
      glLightfv(GL_LIGHT0, GL_POSITION, light0Pos);
      glMaterialfv(GL_FRONT, GL_AMBIENT, matAmb);

     glMaterialfv(GL_FRONT, GL_DIFFUSE, matDiff);
     glMaterialfv(GL_FRONT, GL_SPECULAR, matSpec);
     glMaterialf(GL_FRONT, GL_SHININESS, matShine);

//	  glCullFace(GL_BACK);

 //  glEnable( GL_CULL_FACE );

  glViewport(0,0,width,height);
  glMatrixMode(GL_PROJECTION);
  glLoadIdentity();
  // glOrtho(-1.0,1.0,-1.0,1.0,-1.0,1.0);
  // glOrtho((float)x,(float)x+width,(float)y,(float)y+height,z,zdepth);
  //glFrustum((float)x,(float)x+width,(float)y,(float)y+height,zdepth,zdepth);

    gluPerspective(60.0,(float)width/(float)height,1,1300);
  glMatrixMode(GL_MODELVIEW);
    gluLookAt(-23,110,15,-23,0,15,0,0,1);
    //gluLookAt(-8,10,1,-8,0,1,0,0,1);
    //glLoadIdentity();
    //  glTranslatef(0,50,0);
    //  glRotatef(180.0,0.0,.0,1.0);
    //  glScalef(.3,.3,.3);


  objFan=glGenLists(1);
  objHooverCraft=glGenLists(1);
  objScene=glGenLists(1);

  glNewList(objHooverCraft,GL_COMPILE);
	glColor3f(1.0,0.0,0.0);
  int i;
  for(i=0;i<objects->get_count();i++)
    {
      char *name=((A3dObject *)objects->get_item(i))->get_name();
            if(strcmp(name,"Tube")==0 || strcmp(name,"Body")==0)
	((A3dObject *)objects->get_item(i))->draw_object();
    }
  glEndList();

  glNewList(objScene,GL_COMPILE);
	glColor3f(0.0,1.0,0.0);
  for(i=0;i<objects->get_count();i++)
    {
      char *name=((A3dObject *)objects->get_item(i))->get_name();
         /*   if(strcmp(name,"Floor")==0 || strcmp(name,"Track")==0 ||strcmp(name,"MarkB")==0  
      	 ||strcmp(name,"Ramp01")==0  || strcmp(name,"Ramp02")==0)
      	((A3dObject *)objects->get_item(i))->draw_object();
else
//added*/
            if(strcmp(name,"Tube")==0 || 
   ( strncmp(((A3dObject *)objects->get_item(i))->get_name(),"propeller",9)==0) ||
strcmp(name,"Body")==0)
; else
      	((A3dObject *)objects->get_item(i))->draw_object();
    }
  glEndList();

  glNewList(objFan,GL_COMPILE);
	glColor3f(0.0,0.0,1.0);
  for(i=0;i<objects->get_count();i++)
    if(strncmp(((A3dObject *)objects->get_item(i))->get_name(),"propeller",9)==0)
      ((A3dObject *)objects->get_item(i))->draw_object();
  glEndList();


 
  glutReshapeFunc(reshape);
  glutKeyboardFunc(keyboard);
  glutDisplayFunc(display);
  glutIdleFunc(animate);
}

void ChalkBoard::animate(void)
{
  fanangle++;
  if(fanangle>=360) fanangle=0;
  glutPostRedisplay();
}

void ChalkBoard::keyboard(unsigned char key, int x, int y)
{
  
	switch(key)
    {
	case '5':
      glMatrixMode(GL_MODELVIEW);
      glRotatef(-5,1.0,0.0,0.0);
      break;
    case '/':
      glMatrixMode(GL_MODELVIEW);
      glRotatef(5,1.0,0.0,0.0);
      break;
    case '7':
      glMatrixMode(GL_MODELVIEW);
      glRotatef(5,0.0,1.0,0.0);
      break;
    case '9':
      glMatrixMode(GL_MODELVIEW);
      glRotatef(-5,0.0,1.0,0.0);
      break;

    case '-':
      glMatrixMode(GL_MODELVIEW);
      glScalef(1.0/1.2,1.0/1.2,1.0/1.2);
      break;
    case '+':
      glMatrixMode(GL_MODELVIEW);
      glScalef(1.2,1.2,1.2);

      break;

    case 'q':
    case 'Q':
      exit(0);
      break;
    case '8':
      if(speed<=MAX_SPEED)
	speed++;
      break;
    case '2':
      if(speed>= -MAX_SPEED)
	speed--;
      break;
    case '4':
      directionangle+=5;
      if(directionangle>=360) directionangle=0;

      break;
    case '6':
      directionangle-=5;
      if(directionangle<=-360) directionangle=0;

      break;

    case 'a': case 'A':
      
      break;
    default:
      printf("%d",key);
      break;
    }
}

void ChalkBoard::display(void)
{
  glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
  glColor3f(1.0,1.0,1.0);


 // colldetector->DrawBoundingBoxes();
  
  glPushMatrix();
  glMatrixMode(GL_MODELVIEW);

  ypos-=cos((PI/180.0)*directionangle)*speed*10;
  xpos+=sin((PI/180.0)*directionangle)*speed*10;
  glTranslatef(xpos,ypos,0);
  glRotatef(directionangle,0,0,1);

  glCallList(objHooverCraft);
  glCallList(objFan);

  glPopMatrix();
  glCallList(objScene);
   
  //  glTranslatef(xpos,ypos,0);
  glLoadIdentity();


  gluLookAt(-23+xpos+2*sin((PI/180.0)*directionangle)*110,110+ypos,15,-23+xpos,ypos,15,0,0,1);


  glFlush();
  glutSwapBuffers();  
struct timespec req;
 req.tv_sec = 1/2;
 req.tv_nsec = 1000/2;
  int res = clock_nanosleep (CLOCK_REALTIME, 0, &req, NULL);

}

void ChalkBoard::reshape(int w, int h)
{

}

void ChalkBoard::run(void)
{
  glutMainLoop();
}





